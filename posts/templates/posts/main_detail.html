{% extends 'posts/base.html' %} {% block content %}
<div class="content">
  <div id="main_detail__top">
    <div id="main_detail__top__back_btn">
      <a href="{% url 'posts:home' %}"><i class="fa-solid fa-arrow-left fa-2x"></i></a>
    </div>
    <div id="main_detail__top__main">
      <div id="main_detail__top__left">
        <div id="main_detail__top_left__tag">
          <ul class="main_detail__top_left__ul">
            {% if post.activation %}
            <li id="main__detail__top_left__ul__recruit">모집중</li>
            {% else %}
            <li id="main__detail__top_left__ul__recruit_finish">모집완료</li>
            {% endif %}
            {% for tag in tags %}
            <li>{{tag}}</li>
            {% endfor %}
          </ul>
        </div>
        <div id="main_detail__top__title">{{post.title}}</div>
        <div id="main_detail__top__profile">
          <div id="main_detail__top__img">
            <i class="fa-solid fa-circle-user fa-2x"></i>
          </div>
          <div id="main_detail__top__name">
            <span>{{post.user.nickname}}</span>
          </div>
          <div id="main_detail__top__time">
            <span>{{post.published_at|date:"Y. m. d" }}</span>
          </div>
        </div>
      </div>
      <div id="main_detail__top__right">
        {% if can_revise and post.activation %}
          <div id="main_detail__top__apply">          
            <form action="{% url 'posts:close' post.id %}" method="post">
              {% csrf_token %}
              <!--모집 완료 전환 모달-->
              <div id="main_detail__complete_modal_btn">
                <a>모집완료로 전환</a>
              </div>
              <div id="main_detail__complete_modal">
                <div class="main_detail__complete_modal__overlay">
                  <div class="main_detail__complete_modal__content">
                    <div class="main_detail__complete_modal__close_btn">
                      <i class="fa-solid fa-xmark fa-lg"></i>
                    </div>
                    <h1>모집완료로 전환하시겠어요?</h1>
                    <h3>⚠️한 번 모집 완료로 전환하면 다시 모집중으로 전환이 불가합니다⚠️</h3>
                    <div class="main_detail__complete_modal__btn_flex">
                      <button class="main_detail__complete_btn" type="submit">
                        네, 전환할게요
                      </button>
                      <div class="main_detail__complete_modal__cancel_btn">다시 생각해볼게요</div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
            <div class="main_detail__like_delete_revise">
              <div class="main_detail__top__like">
                <button id="{{post.id}}" onclick="post_like(this.id)">
                  <i id="blank" class="fa-regular fa-heart"></i>
                  <span id="like_count">{{post.likes}}</span>
                </button>
              </div>
              <div class="main_detail__delete_revise">
                <div class="main_detail__delete_revise__dropdown_btn">
                  <i class="fa-solid fa-ellipsis fa-2x" style="color: #BFBFBF"></i>
                </div>
                <div class="main_detail__delete_revise__content">
                  <div class="main_detail__revise_btn">
                    <a href="{% url 'posts:update' post.id%}">수정</a>
                  </div>
                  <form action="{% url 'posts:delete' post.id %}" method="post">
                    {% csrf_token %}
                    <div id="main_detail__delete_modal_btn">
                      <a>삭제</a>
                    </div>
                    <div id="main_detail__delete_modal">
                      <div class="main_detail__delete_modal__overlay">
                        <div class="main_detail__delete_modal__content">
                          <div class="main_detail__delete_modal__close_btn">
                            <i class="fa-solid fa-xmark fa-lg"></i>
                          </div>
                          <h1>게시글을 삭제하시겠어요?</h1>
                          <h3>⚠️한번 삭제하면 복구가 불가합니다⚠️</h3>
                          <div class="main_detail__delete_modal__btn_flex">
                            <button class="main_detail__delete_btn" type="submit">
                              삭제할게요
                            </button>
                            <div class="main_detail__delete_modal__cancel_btn">다시 생각해볼게요</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% elif not can_revise and post.activation %}
          <div id="main_detail__top__apply_2">
            <button id="main_detail__top__apply_btn" type="button" onclick="location.href='{{post.apply_link}}'">
              지원하기
            </button>
            <div class="main_detail__top__like">
              <button id="{{post.id}}" onclick="post_like(this.id)">
                <i id="blank" class="fa-regular fa-heart"></i>
                <span id="like_count">{{post.likes}}</span>
              </button>
            </div>
          </div>
        {% else %}
          <div id="main_detail__top__apply_3">
            <div class="main_detail__top__recruit_done">모집완료</div>
            <div class="main_detail__top__like">
              <button id="{{post.id}}" onclick="post_like(this.id)">
                <i id="blank" class="fa-regular fa-heart"></i>
                <span id="like_count">{{post.likes}}</span>
              </button>
            </div>
          </div>
        {%endif%}
      </div>
    </div>
  <div id="main_detail__main">
    <div id="main_detail__main__info">
      <div>
        <h4>진행방식</h4>
        <span>{{post.get_contact_display}}</span>
      </div>
      <div>
        <h4>모임형태</h4>
        <span>{{post.get_duration_display}}</span>
      </div>
      <div>
        <h4>모집인원</h4>
        <span>{{post.number}}</span>
      </div>
      <div>
        <h4>지역</h4>
        <span>{{post.location}}</span>
      </div>
    </div>
    <div id="main_detail__main__txt">{{post.content | safe}}</div>
  </div>
  <div id="main_detail__comment">
    <div id="main_detail__comment__top">
      <div id="main_detail__comment__blank">
        <h2>댓글</h2>
        <h2 id="main_detail__comment_num">{{comments_len}}</h2>
      </div>
      <div id="main_detail__comment__rule">
        <span>300자 이내 작성</span>
      </div>
    </div>
    <div id="main_detail__comment__blank_box">
      <form action="{% url 'comments:write-post' post.id %}" method="post">
        {% csrf_token %}
        <textarea
          type="text"
          name="content"
          id="comment_input_box"
          cols="30"
          rows="10"
          placeholder="댓글을 입력해주세요."
        ></textarea>
        <div id="main_detail__comment__btnplace">
          <input
            type="submit"
            id="main_detail__comment__btn"
            value="댓글쓰기"
          />
        </div>
      </form>
    </div>
    <div id="main_detail__comment__contents">
      {% for comment in comments %}
      <div id="main_detail__comment__each__contents__{{comment.id}}">
        <div id="main_detail__comment__contents__profile">
          <div id="main_detail__comment__contents__img">
            <i class="fa-solid fa-circle-user fa-2x"></i>
            <img src="{{review.user.profile_img}}" alt="profile_img"></img>
          </div>
          <div id="main_detail__comments__contents__info">
            <div id="main_detail__comments__contents__name">
              <span>{{comment.user.nickname}}</span>
            </div>
            <div id="main_detail__comments__contents__time">
              <span>{{comment.published_at|date:"Y. m. d" }}</span>
            </div>
          </div>
        </div>
        <div id="main_detail__comment__contents__txt__{{comment.id}}">
          <span>{{comment.content}}</span>
        </div>
        <div class="main_detail__comment__contents__reply">
          {% for recomment in comment.comment_set.all %}
          <div>@{{recomment.user.nickname}}{{recomment.content}}</div>
          {% endfor%}
          <div id="main_detail_comment_contents_reply_form__{{comment.id}}"></div>
          
        </div>
        {% if comment.user == request.user %}
        <button onclick="changeForm({{comment.id}}, '{{comment.content}}');">수정</button>
        <button onclick="onClickdelete({{comment.id}});">삭제</button> 
        {% endif%}
        <button onclick="changeForm2({{comment.id}});">답글</button>
        <br />
      </div>
      
      {% endfor %}
    </div>
  </div>
  {%if not post.activation %}
  <div id="main_detail__review">
    <div id="main_detail__review__top">
      <div id="main_detail__review__blank">
        <h2>후기</h2>
        <h2 id="main_detail__review_num">{{review_len}}</h2>
      </div>
      <div id="main_detail__review__rule">
        <span>300자 이내 작성</span>
      </div>
    </div>
    <form action="{% url 'posts:review-write' post.id %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div id="main_detail__review__blank_box">
        <div id="main_detail__review__filebox">
          <label for="main_detail__review__upload_file">
            <div id="main_detail__review__uploadbtn">
              <h1>+</h1>
              <p>이미지를 드래그하거나 <br> 클릭해서 업로드해주세요</p>
            </div>
          </label>
          <input
            type="file"
            name="review_image"
            id="main_detail__review__upload_file"
            accept="image/*"
          />
        </div>
        <textarea
          name="review_content"
          id="review_input_box"
          cols="30"
          rows="10"
          placeholder="후기를 입력하세요."
        ></textarea>
      </div>
      <div id="main_detail__review__btnplace">
        <button type="submit" id="main_detail__review__btn">
          <p>후기 작성</p>
        </button>
      </div>
    </form>
    <div id="main_detail__review__contents">
    {% for review in reviews %}
    {% if review.user == request.user %}
    <div id="main_detail__review__contents_mine">
      <div id="main_detail__review__each__contents__{{review.id}}">
        <div class="main_detail__review__contents_top">
          <div class="review__contents_box__user_info">
            <div class="review__contents_box__profile">
              <div class="review__contents_box__profile_img">
                <i class="fa-solid fa-circle-user fa-3x"></i>
                <img src="{{review.user.profile_img}}" alt="profile_img"></img>
              </div>
              <div class="review__contents_box__info">
                <div class="main_detail__contents__profile_name">
                  <span>{{review.user.nickname}}</span>
                </div>
                <div class="main_detail__contents__profile_time">
                  <span>{{review.write_at|date:"Y. m. d" }}</span>
                </div>
              </div>
            </div>
            {% if review.user == post.user %}
            <div class="review__contents_box__auth">
              <div id="review__contents_box__auth_host">주최자</div>
            </div>
            {% else %}
            <div class="review__contents_box__auth">
              <div id="review__contents_box__auth_guest">참여자</div>
            </div>
            {%endif%}
          </div>
          <div class="main_detail__review__contents_revise">
            <img src="/static/img/dots.png" alt="" />
            {% if review.user == request.user %}
            <button onclick="changeForm3({{review.id}}, '{{review.content}}');">수정</button>
            <button onclick="onClickdelete2({{review.id}})">삭제</button>
            {%endif%}
          </div>
        </div>
        <div class="main_detail__review__contents_content__{{review.id}}">
          {% if review.image %}
          <img src="{{review.image.url}}"/>
          {% else %}
          <p>no image</p>
          {% endif %}
          <div class="main_detail__review__contents_text">
            {{review.content}}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div id="main_detail__review__contents_others">
      <div id="main_detail__review__each__contents__{{review.id}}">
        <div class="main_detail__review__contents_top">
          <div class="review__contents_box__user_info">
            <div class="review__contents_box__profile">
              <div class="review__contents_box__profile_img">
                <i class="fa-solid fa-circle-user fa-3x"></i>
                <img src="{{review.user.profile_img}}" alt="profile_img"></img>
              </div>
              <div class="review__contents_box__info">
                <div class="main_detail__contents__profile_name">
                  <span>{{review.user.nickname}}</span>
                </div>
                <div class="main_detail__contents__profile_time">
                  <span>{{review.write_at|date:"Y. m. d."}}</span>
                </div>
              </div>
            </div>
            {% if review.user == post.user %}
            <div class="review__contents_box__auth">
              <div id="review__contents_box__auth_host">주최자</div>
            </div>
            {% else %}
            <div class="review__contents_box__auth">
              <div id="review__contents_box__auth_guest">참여자</div>
            </div>
            {%endif%}
          </div>
          <div class="main_detail__review__contents_revise">
            <img src="/static/img/dots.png" alt="" />
            {% if review.user == request.user %}
            <button onclick="changeForm3({{review.id}}, '{{review.content}}');">수정</button>
            <button onclick="onClickdelete2({{review.id}})">삭제</button>
            {%endif%}
          </div>
        </div>
        <div class="main_detail__review__contents_content__{{review.id}}">
          {% if review.image %}
          <img src="{{review.image.url}}"/>
          {% else %}
          <p>no image</p>
          {% endif %}
          <div class="main_detail__review__contents_text">
            {{review.content}}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    </div>
    <div>
      {% if reviews.has_previous %}
        <a href="?page={{reviews.previous_page_number}}">이전</a>
      {% endif %}
    
      {% for p in reviews.paginator.page_range %}
        <a href="?page={{p}}" class="mx-1">{{p}}</a>
      {% endfor %}
                
      {% if reviews.has_next %}
            <a href="?page={{reviews.next_page_number}}">다음</a>
      {% endif %}
    </div>
  </div>
  {%endif%}
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!--모집 완료 전환 모달-->
<script>
  const comModal = document.getElementById("main_detail__complete_modal");
  const openComModal = document.getElementById("main_detail__complete_modal_btn");
  openComModal.addEventListener("click", (e) => {
    comModal.style.display = "block";
  });

  const closeComModal = comModal.querySelector(".main_detail__complete_modal__close_btn");
  closeComModal.addEventListener("click", (e) => {
    comModal.style.display = "none";
  });

  const cancelComModal = comModal.querySelector(".main_detail__complete_modal__cancel_btn");
  cancelComModal.addEventListener("click", (e) => {
    comModal.style.display = "none";
  });
</script>

<script>
  const delModal = document.getElementById("main_detail__delete_modal");
  const openDelModal = document.getElementById("main_detail__delete_modal_btn");
  openDelModal.addEventListener("click", (e) => {
    delModal.style.display = "block";
  });

  const closeDelModal = delModal.querySelector(".main_detail__delete_modal__close_btn");
  closeDelModal.addEventListener("click", (e) => {
    delModal.style.display = "none";
  });

  const cancelDelModal = delModal.querySelector(".main_detail__delete_modal__cancel_btn");
  cancelDelModal.addEventListener("click", (e) => {
    delModal.style.display = "none";
  });
</script>

<script>
  const delModal2 = document.getElementById("main_detail__delete_modal_2");
  const openDelModal2 = document.getElementById("main_detail__delete_modal_btn_2");
  openDelModal2.addEventListener("click", (e) => {
    delModal2.style.display = "block";
  });

  const closeDelModal2 = delModal2.querySelector(".main_detail__delete_modal__close_btn");
  closeDelModal2.addEventListener("click", (e) => {
    delModal2.style.display = "none";
  });

  const cancelDelModal2 = delModal2.querySelector(".main_detail__delete_modal__cancel_btn");
  cancelDelModal2.addEventListener("click", (e) => {
    delModal2.style.display = "none";
  });
</script>

<script>
  // 댓글 수정
  const changeForm = (id, content) => {
    const reviseCmt = document.getElementById(`main_detail__comment__contents__txt__${id}`)
    reviseCmt.innerHTML = `<form action="/comment/revise/${id}" method="post">{% csrf_token %}<textarea type="text" name="content">${content}</textarea><input type="submit" value="등록"/><a href="{% url 'posts:detail' post.id %}">취소</a></form>`
  }

  // 대댓글
  const changeForm2 = (id) => {
    const reCmt = document.getElementById(`main_detail_comment_contents_reply_form__${id}`)
    reCmt.innerHTML = `<form action="/comment/recomment/${id}" method="post">{% csrf_token %}<textarea type="text" name="content"></textarea><input type="submit" value="등록"/><a href="{% url 'posts:detail' post.id %}">취소</a></form>`
  }

  // 댓글 삭제
  const cmtDelete = new XMLHttpRequest();
  const onClickdelete = (id) => {
      const url = "/comment/delete";
      cmtDelete.open("POST",url,true);
      cmtDelete.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
      );
      cmtDelete.send(JSON.stringify({'id':id}));
  }
  cmtDelete.onreadystatechange = () => {
      if (cmtDelete.readyState === XMLHttpRequest.DONE){
          if(cmtDelete.status < 400){
              const {id, len} = JSON.parse(cmtDelete.response);
              const topdom = document.getElementById("main_detail__comment__contents");
              const deletedom = document.getElementById(`main_detail__comment__each__contents__${id}`);
              topdom.removeChild(deletedom);
              const cmtLen = document.getElementById('main_detail__comment_num')
              cmtLen.innerHTML = len
          }
      }
  }

  // 후기 수정
  const changeForm3 = (id, content) => {
    console.log(id)
    console.log(content)
    const reviseRvw = document.querySelector(`.main_detail__review__contents_content__${id}`)
    console.log(reviseRvw);
    reviseRvw.innerHTML = `<form action="/post/review/revise/${id}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="main_detail__review__blank_box">
        <div class="main_detail__review__filebox">
          <label for="main_detail__review__upload_file">
            <div class="main_detail__review__uploadbtn">
              <h1>+</h1>
              <p>이미지를 드래그하거나 <br> 클릭해서 업로드해주세요</p>
            </div>
          </label>
          <input
            type="file"
            name="review_image"
            class="main_detail__review__upload_file"
            accept="image/*" />
        </div>
        <textarea
          name="review_content"
          class="review_input_box"
          cols="30"
          rows="10"
        >${content}</textarea>
      </div>
      <div class="main_detail__review__btnplace">
        <button type="submit" class="main_detail__review__btn">
          <p>후기 작성</p>
        </button>
        <a href="{% url 'posts:detail' post.id %}">취소</a>
      </div>
    </form>`
  }

  // 후기 삭제
  const rvwDelete = new XMLHttpRequest();
  const onClickdelete2 = (id) => {
      const url = "/post/review/delete";
      rvwDelete.open("POST",url,true);
      rvwDelete.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
      );
      rvwDelete.send(JSON.stringify({'id':id}));
  }
  rvwDelete.onreadystatechange = () => {
      if (rvwDelete.readyState === XMLHttpRequest.DONE){
          if(rvwDelete.status < 400){
              const {id} = JSON.parse(rvwDelete.response);
              const topdom = document.getElementById("main_detail__review__contents");
              const deletedom = document.getElementById(`main_detail__review__each__contents__${id}`);
              topdom.removeChild(deletedom);
          }
      }
  }

</script>
<script src="https://code.jquery.com/jquery-3.5.1.js"
integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
<script type="text/javascript">
function post_like(id) {
    $.ajax({
        url: "{%url 'users:likes' 1 %}", // data를 전송할 url 입니다. post = 1
        data: {
            'id': id
        }, // id 값 전송
        dataType: "json",
        success: function (response) { // ajax 통신이 정상적으로 완료되었을 때
            $('#like_count').html(response.like_count) //id가 like_count의 내용을 전송받은 좋아요 수로 바꾼다
            if ($('#blank').hasClass("fa-regular fa-heart"))
              $('#blank').removeClass("fa-regular fa-heart").addClass("fa-solid fa-heart");
            else
              $('#blank').removeClass("fa-solid fa-heart").addClass("fa-regular fa-heart");
            if (response.error) {
              window.location.replace("http://127.0.0.1:8000/account/login"); // 배포용 서버로 변경
            } 
        }
    })
}

function dp_menu(){
      let click = document.getElementById("drop-content");
      if(click.style.display === "none"){
          click.style.display = "block";
      }else{
          click.style.display = "none";
      }
  }
</script>

{% endblock content%}